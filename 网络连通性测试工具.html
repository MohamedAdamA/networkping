<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®æ—¶ç¿»å¢™è¿é€šæ€§ & å»¶è¿Ÿç›‘æµ‹</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- æ—¥æœŸé€‚é…å™¨ï¼šè§£å†³ Chart.js time è½´æŠ¥é”™ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <style>
        body {
            background-color: #f9fafb;
            color: #374151;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
            position: relative;
            top: 0;
        }

        .status-online {
            background-color: #10b981;
        }

        .status-offline {
            background-color: #ef4444;
        }

        .status-checking {
            background-color: #f59e0b;
            animation: pulse 2s infinite;
        }

        /* ç›®æ ‡é€‰æ‹©å™¨æ ·å¼ */
        .target-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .target-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .target-checkbox:hover {
            background-color: #f3f4f6;
        }

        .target-checkbox.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        /* ç¦»çº¿ç»Ÿè®¡æ ·å¼ */
        .offline-stats {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* æ‰‹æœºç«¯é€‚é…æ ·å¼ */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .max-w-7xl {
                max-width: 100%;
            }

            /* æ ‡é¢˜é€‚é… */
            h1 {
                font-size: 1.5rem !important;
                line-height: 2rem !important;
            }

            /* æ§åˆ¶é¢æ¿é€‚é… */
            .control-panel {
                flex-direction: column;
                gap: 12px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .control-group label {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .control-group select,
            .control-group button {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }

            /* ç›®æ ‡é€‰æ‹©å™¨é€‚é… */
            .target-selector {
                justify-content: center;
            }

            .target-checkbox {
                padding: 8px 12px;
                font-size: 14px;
            }

            /* è¡¨æ ¼é€‚é… */
            .table-container {
                font-size: 12px;
            }

            .table-container th,
            .table-container td {
                padding: 8px 4px !important;
                font-size: 11px !important;
            }

            .table-container .text-sm {
                font-size: 10px !important;
            }

            .table-container .text-xs {
                font-size: 9px !important;
            }

            /* è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼æ‰‹æœºç«¯éšè—éƒ¨åˆ†åˆ— */
            .detailed-stats-mobile-hidden {
                display: none;
            }

            /* å›¾è¡¨é€‚é… */
            #latencyChart {
                height: 250px !important;
            }

            /* æ¨¡æ€æ¡†é€‚é… */
            .modal-content {
                margin: 20px;
                max-width: calc(100vw - 40px);
            }

            .modal-content .p-6 {
                padding: 16px;
            }

            /* å¡ç‰‡é—´è·é€‚é… */
            .space-y-6>*+* {
                margin-top: 16px;
            }

            .bg-white {
                padding: 16px !important;
            }
        }

        /* å¹³æ¿ç«¯é€‚é… */
        @media (min-width: 769px) and (max-width: 1024px) {
            .control-panel {
                flex-wrap: wrap;
                justify-content: center;
            }

            .control-group {
                min-width: 200px;
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center p-6">
    <!-- é¡¶éƒ¨æ ‡é¢˜ + æ§åˆ¶é¢æ¿ -->
    <header class="mb-6 w-full max-w-7xl text-center">
        <h1 class="text-3xl font-bold mb-2">ğŸŒ å®æ—¶ç½‘é¡µè¿é€šæ€§ & å»¶è¿Ÿç›‘æµ‹</h1>
        <p class="text-gray-600 mb-4">å®æ—¶ç›‘æµ‹ç½‘ç»œå»¶è¿Ÿï¼Œæ”¯æŒå†å²æ•°æ®æŸ¥çœ‹å’ŒPNGå¯¼å‡º</p>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-white rounded-xl shadow p-4 mb-4">
            <div class="control-panel flex flex-wrap items-center justify-center gap-4 mb-4">
                <!-- åˆ·æ–°é—´éš” -->
                <div class="flex items-center gap-2">
                    <label for="intervalSelect" class="font-medium">åˆ·æ–°é—´éš”:</label>
                    <select id="intervalSelect"
                        class="border rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="1000" selected>1 ç§’</option>
                        <option value="5000">5 ç§’</option>
                        <option value="10000">10 ç§’</option>
                        <option value="30000">30 ç§’</option>
                    </select>
                </div>

                <!-- æ—¶é—´èŒƒå›´ -->
                <div class="flex items-center gap-2">
                    <label for="timeRangeSelect" class="font-medium">æ—¶é—´èŒƒå›´:</label>
                    <select id="timeRangeSelect"
                        class="border rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="0.5">30 ç§’</option>
                        <option value="1">1 åˆ†é’Ÿ</option>
                        <option value="5" selected>5 åˆ†é’Ÿ</option>
                        <option value="60">1 å°æ—¶</option>
                        <option value="180">3 å°æ—¶</option>
                        <option value="360">6 å°æ—¶</option>
                        <option value="720">12 å°æ—¶</option>
                        <option value="1440">24 å°æ—¶</option>
                    </select>
                </div>

                <!-- å¯¼å‡ºæŒ‰é’® -->
                <button id="exportBtn"
                    class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    ğŸ“Š å¯¼å‡ºPNG
                </button>

                <!-- æ¸…é™¤æ•°æ®æŒ‰é’® -->
                <button id="clearBtn"
                    class="bg-gray-600 text-white px-4 py-1 rounded hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                    ğŸ—‘ï¸ æ¸…é™¤æ•°æ®
                </button>

                <!-- æ·»åŠ è‡ªå®šä¹‰ç½‘å€æŒ‰é’® -->
                <button id="addCustomBtn"
                    class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                    â• è‡ªå®šä¹‰ç½‘å€
                </button>
            </div>

            <!-- ç›®æ ‡é€‰æ‹©å™¨ -->
            <div class="border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è¦æ˜¾ç¤ºçš„ç›®æ ‡:</label>
                <div class="target-selector" id="targetSelector">
                    <!-- åŠ¨æ€ç”Ÿæˆç›®æ ‡é€‰æ‹©å™¨ -->
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹åŒº -->
    <div class="w-full max-w-7xl space-y-6">
        <!-- å½“å‰çŠ¶æ€è¡¨æ ¼ -->
        <div class="bg-white rounded-2xl shadow p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ å½“å‰çŠ¶æ€</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="status-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ç›®æ ‡</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                çŠ¶æ€</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å½“å‰å»¶è¿Ÿ</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å»¶è¿Ÿç»Ÿè®¡</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                åœ¨çº¿ç»Ÿè®¡</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ç¦»çº¿ç»Ÿè®¡</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ä¸Šæ¬¡æ£€æµ‹</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="status-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è¯¦ç»†ç»Ÿè®¡é¢æ¿ -->
        <div class="bg-white rounded-2xl shadow p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š è¯¦ç»†ç»Ÿè®¡æ•°æ®</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="detailedStatsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th
                                class="px-6 py-4 text-left text-base font-medium text-gray-500 uppercase tracking-wider">
                                ç›®æ ‡</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                æœ€å°å»¶è¿Ÿ</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                æœ€å¤§å»¶è¿Ÿ</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                å¹³å‡å»¶è¿Ÿ</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                æ€»æ£€æµ‹æ¬¡æ•°</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                æˆåŠŸæ¬¡æ•°</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                æˆåŠŸç‡</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                åœ¨çº¿æ—¶é•¿</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                åœ¨çº¿ç‡</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                ç¦»çº¿æ¬¡æ•°</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                ç¦»çº¿æ—¶é•¿</th>
                            <th
                                class="px-6 py-4 text-center text-base font-medium text-gray-500 uppercase tracking-wider">
                                ç¦»çº¿è¯¦æƒ…</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="detailedStatsBody">
                        <!-- åŠ¨æ€ç”Ÿæˆç»Ÿè®¡æ•°æ®è¡Œ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å·¥å…·åŸç†è¯´æ˜ -->
        <div class="bg-white rounded-2xl shadow p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”¬ å·¥å…·åŸç†è¯´æ˜</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- å»¶è¿Ÿæµ‹è¯•åŸç† -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-900 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        å»¶è¿Ÿæµ‹è¯•åŸç†
                    </h3>
                    <div class="text-sm text-blue-800 space-y-2">
                        <p><strong>æµ‹è¯•æ–¹æ³•ï¼š</strong>HTTPè¯·æ±‚å“åº”æ—¶é—´æµ‹é‡</p>
                        <p><strong>æµ‹è¯•è¿‡ç¨‹ï¼š</strong></p>
                        <ol class="list-decimal list-inside ml-4 space-y-1">
                            <li>ä½¿ç”¨JavaScriptçš„Fetch APIå‘é€HTTPè¯·æ±‚</li>
                            <li>è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´ï¼ˆperformance.now()ï¼‰</li>
                            <li>ç­‰å¾…æœåŠ¡å™¨å“åº”</li>
                            <li>è®°å½•å“åº”ç»“æŸæ—¶é—´</li>
                            <li>è®¡ç®—å¾€è¿”æ—¶é—´å·®å€¼</li>
                        </ol>
                        <p><strong>æµ‹è¯•å†…å®¹ï¼š</strong>åŒ…å«DNSè§£æã€TCPè¿æ¥ã€HTTPåè®®å¤„ç†ç­‰å®Œæ•´ç½‘ç»œè®¿é—®æ—¶é—´</p>
                        <p><strong>ä¸pingçš„åŒºåˆ«ï¼š</strong>pingæµ‹è¯•çš„æ˜¯ICMPåè®®çš„çº¯ç½‘ç»œå»¶è¿Ÿï¼Œæœ¬å·¥å…·æµ‹è¯•çš„æ˜¯å®é™…ç½‘é¡µè®¿é—®å»¶è¿Ÿ</p>
                        <div class="mt-3 p-3 bg-blue-100 rounded-md">
                            <p class="font-semibold text-blue-900 mb-2">ğŸ’¡ å»¶è¿Ÿå·®å¼‚è¯´æ˜</p>
                            <div class="text-xs text-blue-800 space-y-1">
                                <p><strong>pingå»¶è¿Ÿ (10ms)</strong> â†’ ä»…ç½‘ç»œå±‚è¿é€šæ€§æµ‹è¯•</p>
                                <p><strong>HTTPå»¶è¿Ÿ (90ms)</strong> â†’ å®Œæ•´Webè®¿é—®æµç¨‹æµ‹è¯•</p>
                                <p class="text-blue-700">HTTPå»¶è¿Ÿé€šå¸¸æ¯”pingé«˜3-10å€æ˜¯æ­£å¸¸ç°è±¡</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å»¶è¿Ÿå¯¹æ¯”è¯´æ˜ -->
                <div class="bg-yellow-50 rounded-lg p-4">
                    <h3 class="font-semibold text-yellow-900 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
                            </path>
                        </svg>
                        å»¶è¿Ÿæµ‹è¯•å¯¹æ¯”
                    </h3>
                    <div class="text-sm text-yellow-800 space-y-3">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-xs">
                                <thead class="bg-yellow-100">
                                    <tr>
                                        <th class="px-2 py-1 text-left font-semibold">æµ‹è¯•æ–¹æ³•</th>
                                        <th class="px-2 py-1 text-center font-semibold">åè®®</th>
                                        <th class="px-2 py-1 text-center font-semibold">å»¶è¿ŸèŒƒå›´</th>
                                        <th class="px-2 py-1 text-center font-semibold">æµ‹è¯•å†…å®¹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t border-yellow-200">
                                        <td class="px-2 py-1 font-medium">pingæµ‹è¯•</td>
                                        <td class="px-2 py-1 text-center">ICMP</td>
                                        <td class="px-2 py-1 text-center">10-30ms</td>
                                        <td class="px-2 py-1">ç½‘ç»œå±‚è¿é€šæ€§</td>
                                    </tr>
                                    <tr class="border-t border-yellow-200">
                                        <td class="px-2 py-1 font-medium">HTTPæµ‹è¯•</td>
                                        <td class="px-2 py-1 text-center">HTTP/HTTPS</td>
                                        <td class="px-2 py-1 text-center">30-200ms</td>
                                        <td class="px-2 py-1">å®Œæ•´Webè®¿é—®æµç¨‹</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="text-yellow-700 font-medium">
                            âš ï¸ HTTPå»¶è¿Ÿæ¯”pingå»¶è¿Ÿé«˜3-10å€æ˜¯æ­£å¸¸ç°è±¡ï¼Œå› ä¸ºåŒ…å«äº†DNSè§£æã€TCPè¿æ¥ã€HTTPå¤„ç†ç­‰å®Œæ•´è¿‡ç¨‹
                        </p>
                    </div>
                </div>

                <!-- æ•°æ®ç»Ÿè®¡è¯´æ˜ -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="font-semibold text-green-900 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                        æ•°æ®ç»Ÿè®¡è¯´æ˜
                    </h3>
                    <div class="text-sm text-green-800 space-y-2">
                        <p><strong>å»¶è¿Ÿç»Ÿè®¡ï¼š</strong></p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>æœ€å°å»¶è¿Ÿï¼šç›‘æµ‹æœŸé—´è®°å½•çš„æœ€å¿«å“åº”æ—¶é—´</li>
                            <li>æœ€å¤§å»¶è¿Ÿï¼šç›‘æµ‹æœŸé—´è®°å½•çš„æœ€æ…¢å“åº”æ—¶é—´</li>
                            <li>å¹³å‡å»¶è¿Ÿï¼šæ‰€æœ‰æˆåŠŸè¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´</li>
                        </ul>
                        <p><strong>è¿æ¥ç»Ÿè®¡ï¼š</strong></p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>æ€»æ£€æµ‹æ¬¡æ•°ï¼šå‘èµ·çš„æ€»è¯·æ±‚æ•°é‡</li>
                            <li>æˆåŠŸæ¬¡æ•°ï¼šæˆåŠŸå“åº”çš„è¯·æ±‚æ•°é‡</li>
                            <li>æˆåŠŸç‡ï¼šæˆåŠŸè¯·æ±‚å æ€»è¯·æ±‚çš„ç™¾åˆ†æ¯”</li>
                        </ul>
                        <p><strong>åœ¨çº¿/ç¦»çº¿ç»Ÿè®¡ï¼š</strong>åŸºäºè¿ç»­çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€è®¡ç®—æ—¶é•¿å’Œæ¬¡æ•°</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®æ—¶æŠ˜çº¿å›¾ -->
        <div class="bg-white rounded-2xl shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">ğŸ“ˆ å®æ—¶å»¶è¿Ÿè¶‹åŠ¿å›¾</h2>
                <div class="text-sm text-gray-500" id="chartStatus">
                    æ˜¾ç¤ºæœ€è¿‘ <span id="currentTimeRange">5</span> åˆ†é’Ÿæ•°æ®
                </div>
            </div>
            <div class="relative">
                <canvas id="latencyChart" height="350"></canvas>
            </div>
        </div>
    </div>

    <!-- è”ç³»æ–¹å¼ -->
    <div class="w-full max-w-7xl mt-8 mb-4">
        <div class="bg-white rounded-2xl shadow p-6 text-center">
            <h2 class="text-xl font-semibold mb-4">ğŸ“ è”ç³»æˆ‘ä»¬</h2>
            <p class="text-gray-600 mb-4">å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„ç”µæŠ¥ç¾¤</p>
            <a href="https://t.me/+RZMe7fnvvUg1OWJl" target="_blank" rel="noopener noreferrer"
                class="inline-flex items-center px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z" />
                </svg>
                åŠ å…¥ç”µæŠ¥ç¾¤
            </a>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç½‘å€æ¨¡æ€æ¡† -->
    <div id="customUrlModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full transform transition-all duration-300 scale-95 opacity-0"
            id="customModalContent">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">æ·»åŠ è‡ªå®šä¹‰ç›‘æµ‹ç½‘å€</h3>
                <button id="closeCustomModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- ä½¿ç”¨å¸®åŠ© -->
            <div class="px-6 py-4 bg-blue-50 border-b">
                <h4 class="font-semibold text-blue-900 mb-2">ğŸ“– ä½¿ç”¨å¸®åŠ©</h4>
                <div class="text-sm text-blue-800 space-y-2">
                    <p><strong>æ”¯æŒçš„ç½‘å€æ ¼å¼ï¼š</strong></p>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li><code>https://example.com</code> - å®Œæ•´HTTPSç½‘å€</li>
                        <li><code>http://example.com</code> - HTTPç½‘å€ï¼ˆä¸æ¨èï¼‰</li>
                        <li><code>https://example.com/path</code> - å¸¦è·¯å¾„çš„ç½‘å€</li>
                        <li><code>https://subdomain.example.com</code> - å­åŸŸå</li>
                    </ul>
                    <p><strong>æ¨èçš„æµ‹è¯•ç«¯ç‚¹ï¼š</strong></p>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li><code>https://example.com/favicon.ico</code> - ç½‘ç«™å›¾æ ‡ï¼ˆé€šå¸¸è¾ƒå°ï¼‰</li>
                        <li><code>https://example.com/robots.txt</code> - æœºå™¨äººæ–‡ä»¶ï¼ˆæ–‡æœ¬æ–‡ä»¶ï¼‰</li>
                        <li><code>https://api.example.com/ping</code> - API pingç«¯ç‚¹</li>
                        <li><code>https://cdn.example.com/logo.png</code> - CDNèµ„æº</li>
                    </ul>
                    <p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>å»ºè®®ä½¿ç”¨HTTPSåè®®ç¡®ä¿å®‰å…¨æ€§</li>
                        <li>é€‰æ‹©å“åº”å¿«çš„è½»é‡çº§èµ„æºè¿›è¡Œæµ‹è¯•</li>
                        <li>é¿å…ä½¿ç”¨éœ€è¦è®¤è¯çš„ç½‘å€</li>
                        <li>æŸäº›ç½‘ç«™å¯èƒ½æœ‰CORSé™åˆ¶ï¼Œå½±å“æµ‹è¯•ç»“æœ</li>
                    </ul>
                </div>
            </div>

            <div class="p-6">
                <form id="customUrlForm" class="space-y-4">
                    <div>
                        <label for="customName" class="block text-sm font-medium text-gray-700 mb-2">
                            ç½‘ç«™åç§° <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="customName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç½‘ç«™" required>
                        <p class="text-xs text-gray-500 mt-1">ä¸ºè¿™ä¸ªç›‘æµ‹ç›®æ ‡è®¾ç½®ä¸€ä¸ªæ˜“è¯†åˆ«çš„åç§°</p>
                    </div>

                    <div>
                        <label for="customUrl" class="block text-sm font-medium text-gray-700 mb-2">
                            æµ‹è¯•ç½‘å€ <span class="text-red-500">*</span>
                        </label>
                        <input type="url" id="customUrl"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="https://example.com/favicon.ico" required>
                        <p class="text-xs text-gray-500 mt-1">è¾“å…¥è¦ç›‘æµ‹çš„å®Œæ•´ç½‘å€ï¼Œå»ºè®®ä½¿ç”¨è½»é‡çº§èµ„æº</p>
                    </div>

                    <div>
                        <label for="customColor" class="block text-sm font-medium text-gray-700 mb-2">
                            å›¾è¡¨é¢œè‰²
                        </label>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="customColor" value="#8b5cf6"
                                class="w-12 h-10 border border-gray-300 rounded cursor-pointer">
                            <span class="text-sm text-gray-600">é€‰æ‹©åœ¨å›¾è¡¨ä¸­æ˜¾ç¤ºçš„é¢œè‰²</span>
                        </div>
                    </div>

                    <!-- å®ä¾‹å±•ç¤º -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h5 class="font-medium text-gray-900 mb-2">ğŸ’¡ é…ç½®å®ä¾‹</h5>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ç½‘ç«™åç§°:</span>
                                <span class="font-mono">GitHub</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">æµ‹è¯•ç½‘å€:</span>
                                <span class="font-mono">https://github.com/favicon.ico</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">å›¾è¡¨é¢œè‰²:</span>
                                <div class="w-4 h-4 bg-purple-500 rounded"></div>
                            </div>
                        </div>
                    </div>

                    <!-- è¡¨å•éªŒè¯æç¤º -->
                    <div id="customFormError" class="hidden p-3 bg-red-50 border border-red-200 rounded-md">
                        <div class="flex">
                            <svg class="w-5 h-5 text-red-400 mr-2 flex-shrink-0" fill="currentColor"
                                viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <div class="text-sm text-red-700" id="customFormErrorMessage"></div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button id="cancelCustomUrl"
                    class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                    å–æ¶ˆ
                </button>
                <button id="confirmCustomUrl"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    æ·»åŠ ç›‘æµ‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // =============== é…ç½®ç›®æ ‡ç«™ç‚¹ ===============
        const targets = [
            {
                name: "Google",
                testUrls: [
                    "https://clients3.google.com/generate_204",
                    "https://www.google.com/favicon.ico"
                ],
                color: "rgb(59, 130, 246)",
                enabled: true
            },
            {
                name: "YouTube",
                testUrls: [
                    "https://www.youtube.com/generate_204",
                    "https://www.youtube.com/favicon.ico"
                ],
                color: "rgb(239, 68, 68)",
                enabled: true
            },
            {
                name: "Instagram",
                testUrls: [
                    "https://www.instagram.com/favicon.ico"
                ],
                color: "rgb(236, 72, 153)",
                enabled: true
            },
            {
                name: "X / Twitter",
                testUrls: [
                    "https://abs.twimg.com/favicons/twitter.ico",
                    "https://x.com/favicon.ico"
                ],
                color: "rgb(15, 23, 42)",
                enabled: true
            },
            {
                name: "ç™¾åº¦",
                testUrls: [
                    "https://www.baidu.com/favicon.ico"
                ],
                color: "rgb(37, 99, 235)",
                enabled: true
            },
            {
                name: "è…¾è®¯è§†é¢‘",
                testUrls: [
                    "https://v.qq.com/favicon.ico"
                ],
                color: "rgb(34, 197, 94)",
                enabled: true
            }
        ];

        // =============== å…¨å±€å˜é‡ ===============
        const intervalSelect = document.getElementById("intervalSelect");
        const timeRangeSelect = document.getElementById("timeRangeSelect");
        const exportBtn = document.getElementById("exportBtn");
        const clearBtn = document.getElementById("clearBtn");
        const addCustomBtn = document.getElementById("addCustomBtn");
        const tbody = document.getElementById("status-tbody");
        const targetSelector = document.getElementById("targetSelector");

        let UPDATE_INTERVAL = Number(intervalSelect.value);
        let TIME_RANGE_MINUTES = Number(timeRangeSelect.value);
        let HISTORY_LENGTH = Math.floor((TIME_RANGE_MINUTES * 60 * 1000) / UPDATE_INTERVAL);
        let timerId;
        let latencyChart;

        // è¯¦ç»†ç»Ÿè®¡æ•°æ®
        let detailedStats = {};
        targets.forEach(t => {
            detailedStats[t.name] = {
                // å»¶è¿Ÿç»Ÿè®¡
                latencies: [],
                minLatency: null,
                maxLatency: null,
                avgLatency: null,

                // ç¦»çº¿ç»Ÿè®¡
                offlineCount: 0,
                totalOfflineTime: 0,
                lastOfflineStart: null,
                isCurrentlyOffline: false,
                offlineEvents: [], // è®°å½•æ¯æ¬¡ç¦»çº¿äº‹ä»¶ {start, end, duration}

                // åœ¨çº¿ç»Ÿè®¡
                totalOnlineTime: 0,
                lastOnlineStart: null,
                isCurrentlyOnline: false,
                onlineEvents: [], // è®°å½•æ¯æ¬¡åœ¨çº¿äº‹ä»¶ {start, end, duration}

                // ä¼šè¯ç»Ÿè®¡
                sessionStart: Date.now(),
                totalChecks: 0,
                successfulChecks: 0
            };
        });

        // =============== DOM åˆå§‹åŒ– ===============
        function initializeTargetSelector() {
            targetSelector.innerHTML = '';
            targets.forEach((target, index) => {
                const div = document.createElement('div');
                div.className = `target-checkbox ${target.enabled ? 'selected' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" ${target.enabled ? 'checked' : ''} 
                           onchange="toggleTarget(${index})" style="margin: 0;">
                    <div class="w-3 h-3 rounded-full" style="background-color: ${target.color}"></div>
                    <span class="text-sm font-medium">${target.name}</span>
                `;
                targetSelector.appendChild(div);
            });
        }

        function initializeTable() {
            tbody.innerHTML = '';
            targets.forEach(t => {
                const tr = document.createElement("tr");
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-3" style="background-color: ${t.color}"></div>
                            <div class="text-sm font-medium text-gray-900">${t.name}</div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center">
                            <span class="status-indicator status-checking"></span>
                            <span id="${t.name}-status" class="ml-2 text-sm w-12 text-center">å¾…æ£€æµ‹</span>
                        </div>
                    </td>
                    <td id="${t.name}-latency" class="px-4 py-4 whitespace-nowrap text-center text-sm font-mono">â€”</td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <div id="${t.name}-latency-stats" class="text-xs text-gray-600">
                            æœ€å°: â€”<br>
                            æœ€å¤§: â€”<br>
                            å¹³å‡: â€”
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <div id="${t.name}-online-stats" class="text-xs text-gray-600">
                            åœ¨çº¿æ—¶é•¿: â€”<br>
                            åœ¨çº¿ç‡: â€”
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <div id="${t.name}-offline-stats" class="text-xs text-gray-600">
                            ç¦»çº¿æ¬¡æ•°: 0<br>
                            ç¦»çº¿æ—¶é•¿: 0s
                        </div>
                    </td>
                    <td id="${t.name}-time" class="px-4 py-4 whitespace-nowrap text-center text-sm text-gray-500">â€”</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function initializeDetailedStats() {
            const tbody = document.getElementById('detailedStatsBody');
            tbody.innerHTML = '';
            targets.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-3" style="background-color: ${t.color}"></div>
                            <div class="text-base font-medium text-gray-900">${t.name}</div>
                        </div>
                    </td>
                    <td id="${t.name}-detailed-min" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">â€”</td>
                    <td id="${t.name}-detailed-max" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">â€”</td>
                    <td id="${t.name}-detailed-avg" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">â€”</td>
                    <td id="${t.name}-detailed-total" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">0</td>
                    <td id="${t.name}-detailed-success" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">0</td>
                    <td id="${t.name}-detailed-rate" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">â€”</td>
                    <td id="${t.name}-detailed-online-time" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">â€”</td>
                    <td id="${t.name}-detailed-online-rate" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">â€”</td>
                    <td id="${t.name}-detailed-offline-count" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">0</td>
                    <td id="${t.name}-detailed-offline-time" class="px-6 py-4 whitespace-nowrap text-center text-base font-mono text-gray-900">â€”</td>
                    <td id="${t.name}-detailed-offline-details" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        <div class="max-w-xs">
                            <div class="text-xs text-gray-600">æš‚æ— ç¦»çº¿è®°å½•</div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // =============== Chart.js åˆå§‹åŒ– ===============
        function initializeChart() {
            const ctx = document.getElementById("latencyChart").getContext("2d");

            latencyChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: targets.map(t => ({
                        label: t.name,
                        data: [],
                        borderColor: t.color,
                        backgroundColor: t.color + '20',
                        tension: 0.3,
                        spanGaps: false, // ä¸è¿æ¥ç¦»çº¿ç‚¹
                        pointRadius: 2,
                        pointHoverRadius: 4,
                        borderWidth: 2,
                        fill: false,
                        hidden: !t.enabled
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                filter: function (legendItem, chartData) {
                                    const index = legendItem.datasetIndex;
                                    return targets[index].enabled;
                                }
                            }
                        },
                        tooltip: {
                            mode: "nearest",
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#374151',
                            bodyColor: '#374151',
                            borderColor: '#d1d5db',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed.y;
                                    return value !== null ? `${context.dataset.label}: ${value}ms` : `${context.dataset.label}: ç¦»çº¿`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: "time",
                            time: {
                                unit: TIME_RANGE_MINUTES <= 5 ? "second" : "minute",
                                displayFormats: {
                                    minute: "HH:mm",
                                    second: "HH:mm:ss"
                                }
                            },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 12
                            },
                            title: {
                                display: true,
                                text: 'æ—¶é—´',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            suggestedMin: 0,
                            title: {
                                display: true,
                                text: "å»¶è¿Ÿ (ms)",
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // =============== ç›®æ ‡åˆ‡æ¢åŠŸèƒ½ ===============
        function toggleTarget(index) {
            targets[index].enabled = !targets[index].enabled;

            // æ›´æ–°é€‰æ‹©å™¨æ ·å¼
            const selector = targetSelector.children[index];
            if (targets[index].enabled) {
                selector.classList.add('selected');
            } else {
                selector.classList.remove('selected');
            }

            // æ›´æ–°å›¾è¡¨æ˜¾ç¤º
            latencyChart.data.datasets[index].hidden = !targets[index].enabled;
            latencyChart.update('none');
        }

        // =============== è‡ªå®šä¹‰ç½‘å€åŠŸèƒ½ ===============
        function showCustomUrlModal() {
            const modal = document.getElementById('customUrlModal');
            const modalContent = document.getElementById('customModalContent');

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            setTimeout(() => {
                document.getElementById('customName').focus();
            }, 150);
        }

        function hideCustomUrlModal() {
            const modal = document.getElementById('customUrlModal');
            const modalContent = document.getElementById('customModalContent');

            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.getElementById('customUrlForm').reset();
                hideCustomFormError();
            }, 150);
        }

        function showCustomFormError(message) {
            const errorDiv = document.getElementById('customFormError');
            const errorMessage = document.getElementById('customFormErrorMessage');

            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideCustomFormError() {
            const errorDiv = document.getElementById('customFormError');
            errorDiv.classList.add('hidden');
        }

        function handleAddCustomUrl() {
            const name = document.getElementById('customName').value.trim();
            const url = document.getElementById('customUrl').value.trim();
            const color = document.getElementById('customColor').value;

            // éªŒè¯è¡¨å•
            if (!name) {
                showCustomFormError('è¯·è¾“å…¥ç½‘ç«™åç§°');
                document.getElementById('customName').focus();
                return;
            }

            if (!url) {
                showCustomFormError('è¯·è¾“å…¥æµ‹è¯•ç½‘å€');
                document.getElementById('customUrl').focus();
                return;
            }

            if (!isValidURL(url)) {
                showCustomFormError('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€æ ¼å¼ï¼ˆéœ€åŒ…å«http://æˆ–https://ï¼‰');
                document.getElementById('customUrl').focus();
                return;
            }

            // æ£€æŸ¥æ˜¯å¦é‡å¤
            if (targets.some(t => t.testUrls.includes(url))) {
                showCustomFormError('è¯¥ç½‘å€å·²å­˜åœ¨ï¼Œè¯·å‹¿é‡å¤æ·»åŠ ');
                return;
            }

            // æ·»åŠ æ–°ç›®æ ‡
            const newTarget = {
                name: name,
                testUrls: [url],
                color: color,
                enabled: true,
                isCustom: true
            };

            targets.push(newTarget);

            // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
            detailedStats[name] = {
                latencies: [],
                minLatency: null,
                maxLatency: null,
                avgLatency: null,
                offlineCount: 0,
                totalOfflineTime: 0,
                lastOfflineStart: null,
                isCurrentlyOffline: false,
                offlineEvents: [],
                totalOnlineTime: 0,
                lastOnlineStart: null,
                isCurrentlyOnline: false,
                onlineEvents: [],
                sessionStart: Date.now(),
                totalChecks: 0,
                successfulChecks: 0
            };

            // é‡æ–°åˆå§‹åŒ–ç•Œé¢
            initializeTargetSelector();
            initializeTable();
            initializeDetailedStats();

            // æ›´æ–°å›¾è¡¨
            latencyChart.data.datasets.push({
                label: name,
                data: [],
                borderColor: color,
                backgroundColor: color + '20',
                tension: 0.3,
                spanGaps: false,
                pointRadius: 2,
                pointHoverRadius: 4,
                borderWidth: 2,
                fill: false,
                hidden: false
            });

            latencyChart.update('none');

            hideCustomUrlModal();
            showNotification(`è‡ªå®šä¹‰ç›®æ ‡"${name}"æ·»åŠ æˆåŠŸ`, 'success');
        }

        function isValidURL(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        // =============== HTTPå»¶è¿Ÿæ£€æµ‹é€»è¾‘ ===============
        async function pingTarget(target) {
            try {
                const results = [];
                const testCount = 2; // å‡å°‘æµ‹è¯•æ¬¡æ•°æé«˜é€Ÿåº¦

                for (let i = 0; i < testCount; i++) {
                    const latency = await singleHttpTest(target, i);
                    if (latency !== null) {
                        results.push(latency);
                    }

                    if (i < testCount - 1) {
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }

                if (results.length === 0) return null;

                // å–æœ€å°å€¼ä½œä¸ºæœ€ä½³ç»“æœ
                return Math.min(...results);

            } catch (error) {
                console.log(`${target.name} æ£€æµ‹å¤±è´¥:`, error.message);
                return null;
            }
        }

        async function singleHttpTest(target, testIndex) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);

                const start = performance.now();

                const testUrl = target.testUrls[testIndex % target.testUrls.length];
                const uniqueUrl = testUrl + `?t=${Date.now()}&i=${testIndex}`;

                await fetch(uniqueUrl, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-store',
                    signal: controller.signal,
                    redirect: 'follow'
                });

                clearTimeout(timeoutId);
                const latency = Math.round(performance.now() - start);

                return Math.max(1, Math.min(latency, 10000));

            } catch (error) {
                return null;
            }
        }

        // =============== è¯¦ç»†ç»Ÿè®¡åŠŸèƒ½ ===============
        function updateDetailedStats(targetName, isOnline, latency = null) {
            const stats = detailedStats[targetName];
            const now = Date.now();

            // æ›´æ–°æ£€æµ‹ç»Ÿè®¡
            stats.totalChecks++;
            if (isOnline) {
                stats.successfulChecks++;

                // æ›´æ–°å»¶è¿Ÿç»Ÿè®¡
                if (latency !== null) {
                    stats.latencies.push(latency);
                    stats.minLatency = stats.minLatency === null ? latency : Math.min(stats.minLatency, latency);
                    stats.maxLatency = stats.maxLatency === null ? latency : Math.max(stats.maxLatency, latency);
                    stats.avgLatency = stats.latencies.reduce((sum, l) => sum + l, 0) / stats.latencies.length;
                }
            }

            // å¤„ç†åœ¨çº¿/ç¦»çº¿çŠ¶æ€å˜åŒ–
            if (isOnline && !stats.isCurrentlyOnline) {
                // åˆšåˆšä¸Šçº¿
                if (stats.isCurrentlyOffline && stats.lastOfflineStart) {
                    // ç»“æŸç¦»çº¿äº‹ä»¶
                    const offlineDuration = now - stats.lastOfflineStart;
                    stats.totalOfflineTime += offlineDuration;
                    stats.offlineEvents.push({
                        start: stats.lastOfflineStart,
                        end: now,
                        duration: offlineDuration
                    });
                    stats.isCurrentlyOffline = false;
                    stats.lastOfflineStart = null;
                }

                // å¼€å§‹åœ¨çº¿äº‹ä»¶
                stats.isCurrentlyOnline = true;
                stats.lastOnlineStart = now;

            } else if (!isOnline && stats.isCurrentlyOnline) {
                // åˆšåˆšç¦»çº¿
                if (stats.lastOnlineStart) {
                    // ç»“æŸåœ¨çº¿äº‹ä»¶
                    const onlineDuration = now - stats.lastOnlineStart;
                    stats.totalOnlineTime += onlineDuration;
                    stats.onlineEvents.push({
                        start: stats.lastOnlineStart,
                        end: now,
                        duration: onlineDuration
                    });
                    stats.isCurrentlyOnline = false;
                    stats.lastOnlineStart = null;
                }

                // å¼€å§‹ç¦»çº¿äº‹ä»¶
                stats.isCurrentlyOffline = true;
                stats.lastOfflineStart = now;
                stats.offlineCount++;

            } else if (!isOnline && !stats.isCurrentlyOffline) {
                // é¦–æ¬¡ç¦»çº¿
                stats.isCurrentlyOffline = true;
                stats.lastOfflineStart = now;
                stats.offlineCount++;

            } else if (isOnline && !stats.isCurrentlyOnline) {
                // é¦–æ¬¡åœ¨çº¿
                stats.isCurrentlyOnline = true;
                stats.lastOnlineStart = now;
            }

            // æ›´æ–°æ˜¾ç¤º
            updateStatsDisplay(targetName);
        }

        function updateStatsDisplay(targetName) {
            const stats = detailedStats[targetName];
            const now = Date.now();

            // è®¡ç®—å½“å‰çŠ¶æ€çš„æ—¶é•¿
            let currentOnlineTime = 0;
            let currentOfflineTime = 0;

            if (stats.isCurrentlyOnline && stats.lastOnlineStart) {
                currentOnlineTime = now - stats.lastOnlineStart;
            }
            if (stats.isCurrentlyOffline && stats.lastOfflineStart) {
                currentOfflineTime = now - stats.lastOfflineStart;
            }

            const totalOnlineTime = stats.totalOnlineTime + currentOnlineTime;
            const totalOfflineTime = stats.totalOfflineTime + currentOfflineTime;
            const totalSessionTime = now - stats.sessionStart;

            // æ›´æ–°è¡¨æ ¼ä¸­çš„ç»Ÿè®¡
            const latencyStatsElement = document.getElementById(`${targetName}-latency-stats`);
            if (latencyStatsElement) {
                latencyStatsElement.innerHTML = `
                    æœ€å°: ${stats.minLatency !== null ? stats.minLatency + 'ms' : 'â€”'}<br>
                    æœ€å¤§: ${stats.maxLatency !== null ? stats.maxLatency + 'ms' : 'â€”'}<br>
                    å¹³å‡: ${stats.avgLatency !== null ? Math.round(stats.avgLatency) + 'ms' : 'â€”'}
                `;
            }

            const onlineStatsElement = document.getElementById(`${targetName}-online-stats`);
            if (onlineStatsElement) {
                const onlineRate = totalSessionTime > 0 ? (totalOnlineTime / totalSessionTime * 100).toFixed(1) : '0';
                onlineStatsElement.innerHTML = `
                    åœ¨çº¿æ—¶é•¿: ${formatDuration(Math.round(totalOnlineTime / 1000))}<br>
                    åœ¨çº¿ç‡: ${onlineRate}%
                `;
            }

            const offlineStatsElement = document.getElementById(`${targetName}-offline-stats`);
            if (offlineStatsElement) {
                offlineStatsElement.innerHTML = `
                    ç¦»çº¿æ¬¡æ•°: ${stats.offlineCount}<br>
                    ç¦»çº¿æ—¶é•¿: ${formatDuration(Math.round(totalOfflineTime / 1000))}
                `;
            }

            // æ›´æ–°è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼
            const successRate = stats.totalChecks > 0 ? (stats.successfulChecks / stats.totalChecks * 100).toFixed(1) : '0';
            const onlineRate = totalSessionTime > 0 ? (totalOnlineTime / totalSessionTime * 100).toFixed(1) : '0';

            // ç”Ÿæˆç¦»çº¿è¯¦æƒ…
            let offlineDetails = 'æš‚æ— ç¦»çº¿è®°å½•';
            if (stats.offlineEvents.length > 0 || stats.isCurrentlyOffline) {
                let offlineList = [];

                // æ·»åŠ å½“å‰æ­£åœ¨è¿›è¡Œçš„ç¦»çº¿ï¼ˆå¦‚æœæœ‰ï¼‰
                if (stats.isCurrentlyOffline && stats.lastOfflineStart) {
                    const startTime = new Date(stats.lastOfflineStart).toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const currentDuration = formatDuration(Math.round((now - stats.lastOfflineStart) / 1000));
                    offlineList.push(`<span class="text-red-600 font-medium">${startTime} - è¿›è¡Œä¸­ (${currentDuration})</span>`);
                }

                // æ·»åŠ å†å²ç¦»çº¿è®°å½•
                if (stats.offlineEvents.length > 0) {
                    const recentOfflines = stats.offlineEvents.slice(-2); // æ˜¾ç¤ºæœ€è¿‘2æ¬¡å†å²ç¦»çº¿
                    const historicalOfflines = recentOfflines.map(event => {
                        const startTime = new Date(event.start).toLocaleString('zh-CN', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const endTime = new Date(event.end).toLocaleString('zh-CN', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const duration = formatDuration(Math.round(event.duration / 1000));
                        return `${startTime} - ${endTime} (${duration})`;
                    });
                    offlineList = offlineList.concat(historicalOfflines);
                }

                offlineDetails = offlineList.join('<br>');

                // å¦‚æœæœ‰æ›´å¤šå†å²è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
                const totalHistorical = stats.offlineEvents.length;
                const shownHistorical = Math.min(2, totalHistorical);
                if (totalHistorical > shownHistorical) {
                    offlineDetails += `<br><span class="text-xs text-gray-400">...è¿˜æœ‰${totalHistorical - shownHistorical}æ¬¡å†å²è®°å½•</span>`;
                }
            }

            // æ›´æ–°è¡¨æ ¼ä¸­çš„å„ä¸ªå•å…ƒæ ¼
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };

            const updateElementHTML = (id, html) => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = html;
            };

            updateElement(`${targetName}-detailed-min`, stats.minLatency !== null ? stats.minLatency + 'ms' : 'â€”');
            updateElement(`${targetName}-detailed-max`, stats.maxLatency !== null ? stats.maxLatency + 'ms' : 'â€”');
            updateElement(`${targetName}-detailed-avg`, stats.avgLatency !== null ? Math.round(stats.avgLatency) + 'ms' : 'â€”');
            updateElement(`${targetName}-detailed-total`, stats.totalChecks);
            updateElement(`${targetName}-detailed-success`, stats.successfulChecks);
            updateElement(`${targetName}-detailed-rate`, successRate + '%');
            updateElement(`${targetName}-detailed-online-time`, formatDuration(Math.round(totalOnlineTime / 1000)));
            updateElement(`${targetName}-detailed-online-rate`, onlineRate + '%');
            updateElement(`${targetName}-detailed-offline-count`, stats.offlineCount);
            updateElement(`${targetName}-detailed-offline-time`, formatDuration(Math.round(totalOfflineTime / 1000)));
            updateElementHTML(`${targetName}-detailed-offline-details`, `<div class="max-w-xs"><div class="text-xs text-gray-600">${offlineDetails}</div></div>`);
        }

        function formatDuration(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function updateTable(name, ok, latency) {
            const statusElement = document.getElementById(`${name}-status`);
            const latencyElement = document.getElementById(`${name}-latency`);
            const timeElement = document.getElementById(`${name}-time`);

            // æ›´æ–°è¯¦ç»†ç»Ÿè®¡
            updateDetailedStats(name, ok, latency);

            // æ›´æ–°çŠ¶æ€
            if (ok) {
                const statusContainer = statusElement.parentElement;
                statusContainer.innerHTML = `
                    <span class="status-indicator status-online"></span>
                    <span id="${name}-status" class="ml-2 text-sm w-12 text-center text-green-600 font-medium">åœ¨çº¿</span>
                `;
                latencyElement.textContent = latency + "ms";
                latencyElement.className = latency < 100 ? "px-4 py-4 whitespace-nowrap text-center text-sm font-mono text-green-600 font-bold" :
                    latency < 300 ? "px-4 py-4 whitespace-nowrap text-center text-sm font-mono text-yellow-600 font-bold" :
                        "px-4 py-4 whitespace-nowrap text-center text-sm font-mono text-red-600 font-bold";
            } else {
                const statusContainer = statusElement.parentElement;
                statusContainer.innerHTML = `
                    <span class="status-indicator status-offline"></span>
                    <span id="${name}-status" class="ml-2 text-sm w-12 text-center text-red-600 font-medium">ç¦»çº¿</span>
                `;
                latencyElement.textContent = "â€”";
                latencyElement.className = "px-4 py-4 whitespace-nowrap text-center text-sm font-mono text-gray-500";
            }

            timeElement.textContent = new Date().toLocaleTimeString('zh-CN');
        }

        async function runCheck() {
            const ts = Date.now();

            // æ›´æ–°æ‰€æœ‰å¯ç”¨ç›®æ ‡ä¸ºæ£€æµ‹ä¸­çŠ¶æ€
            targets.forEach(t => {
                if (t.enabled) {
                    const statusElement = document.getElementById(`${t.name}-status`);
                    const statusContainer = statusElement.parentElement;
                    statusContainer.innerHTML = `
                        <span class="status-indicator status-checking"></span>
                        <span id="${t.name}-status" class="ml-2 text-sm w-12 text-center text-yellow-600">æ£€æµ‹ä¸­</span>
                    `;
                }
            });

            // æ·»åŠ æ—¶é—´æ ‡ç­¾
            latencyChart.data.labels.push(ts);
            if (latencyChart.data.labels.length > HISTORY_LENGTH) {
                latencyChart.data.labels.shift();
            }

            // å¹¶å‘æ£€æµ‹æ‰€æœ‰å¯ç”¨çš„ç›®æ ‡
            await Promise.all(targets.map(async (t, idx) => {
                if (!t.enabled) return;

                const rawLatency = await pingTarget(t);
                const latency = optimizeLatency(rawLatency, t.name);
                const ok = latency !== null;

                updateTable(t.name, ok, latency);

                const ds = latencyChart.data.datasets[idx].data;
                ds.push({ x: ts, y: latency });
                if (ds.length > HISTORY_LENGTH) {
                    ds.shift();
                }
            }));

            latencyChart.update("none");
        }

        function startLoop() {
            if (timerId) clearInterval(timerId);
            timerId = setInterval(runCheck, UPDATE_INTERVAL);
        }

        // =============== äº‹ä»¶ç›‘å¬å™¨ ===============
        intervalSelect.addEventListener("change", () => {
            UPDATE_INTERVAL = Number(intervalSelect.value);
            HISTORY_LENGTH = Math.floor((TIME_RANGE_MINUTES * 60 * 1000) / UPDATE_INTERVAL);
            startLoop();
        });

        timeRangeSelect.addEventListener("change", () => {
            TIME_RANGE_MINUTES = Number(timeRangeSelect.value);
            HISTORY_LENGTH = Math.floor((TIME_RANGE_MINUTES * 60 * 1000) / UPDATE_INTERVAL);

            // æ›´æ–°æ—¶é—´è½´å•ä½
            latencyChart.options.scales.x.time.unit = TIME_RANGE_MINUTES <= 5 ? "second" : "minute";

            // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
            const rangeText = TIME_RANGE_MINUTES < 1 ? `${TIME_RANGE_MINUTES * 60} ç§’` :
                TIME_RANGE_MINUTES === 1 ? "1 åˆ†é’Ÿ" :
                    TIME_RANGE_MINUTES < 60 ? `${TIME_RANGE_MINUTES} åˆ†é’Ÿ` :
                        `${TIME_RANGE_MINUTES / 60} å°æ—¶`;
            document.getElementById("currentTimeRange").textContent = rangeText;

            // æ¸…ç†è¶…å‡ºèŒƒå›´çš„å†å²æ•°æ®
            const cutoffTime = Date.now() - TIME_RANGE_MINUTES * 60 * 1000;
            latencyChart.data.labels = latencyChart.data.labels.filter(label => label >= cutoffTime);
            latencyChart.data.datasets.forEach(dataset => {
                dataset.data = dataset.data.filter(point => point.x >= cutoffTime);
            });
            latencyChart.update("none");
        });

        // =============== é«˜çº§PNGå¯¼å‡ºåŠŸèƒ½ ===============
        exportBtn.addEventListener("click", () => {
            const originalText = exportBtn.textContent;
            exportBtn.textContent = "ğŸ“Š å¯¼å‡ºä¸­...";
            exportBtn.disabled = true;

            setTimeout(() => {
                try {
                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶canvasç”¨äºç”Ÿæˆå¸¦èƒŒæ™¯çš„å›¾ç‰‡
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');

                    // è®¾ç½®canvaså°ºå¯¸ - ä¸ºè¡¨æ ¼å¸ƒå±€ä¼˜åŒ–
                    tempCanvas.width = Math.max(latencyChart.canvas.width, 1600); // å¢åŠ å®½åº¦ä»¥é€‚åº”æ–°åˆ—
                    const enabledCount = targets.filter(t => t.enabled).length;
                    const tableHeight = Math.max(250, enabledCount * 50 + 150); // æ ¹æ®ç›®æ ‡æ•°é‡åŠ¨æ€è®¡ç®—è¡¨æ ¼é«˜åº¦ï¼Œé€‚åº”æ›´å¤§å­—ä½“
                    tempCanvas.height = latencyChart.canvas.height + 450 + tableHeight; // ä¼˜åŒ–æ€»é«˜åº¦

                    // ç»˜åˆ¶ç™½è‰²èƒŒæ™¯
                    tempCtx.fillStyle = '#ffffff';
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

                    // ç»˜åˆ¶æ ‡é¢˜
                    tempCtx.fillStyle = '#1f2937';
                    tempCtx.font = 'bold 28px Arial, sans-serif';
                    tempCtx.textAlign = 'center';
                    tempCtx.fillText('ç½‘ç»œå»¶è¿Ÿç›‘æµ‹æŠ¥å‘Š', tempCanvas.width / 2, 40);

                    // ç»˜åˆ¶åŸºæœ¬ä¿¡æ¯
                    tempCtx.font = '14px Arial, sans-serif';
                    tempCtx.fillStyle = '#6b7280';
                    const now = new Date();
                    const timeInfo = `å¯¼å‡ºæ—¶é—´: ${now.toLocaleString('zh-CN')} | æ—¶é—´èŒƒå›´: ${document.getElementById("currentTimeRange").textContent} | åˆ·æ–°é—´éš”: ${intervalSelect.options[intervalSelect.selectedIndex].text}`;
                    tempCtx.fillText(timeInfo, tempCanvas.width / 2, 70);

                    const enabledTargets = targets.filter(t => t.enabled).map(t => t.name).join(', ');
                    tempCtx.fillText(`ç›‘æµ‹ç›®æ ‡: ${enabledTargets}`, tempCanvas.width / 2, 90);

                    // ç»˜åˆ¶å›¾è¡¨
                    const chartY = 120;
                    tempCtx.drawImage(latencyChart.canvas, (tempCanvas.width - latencyChart.canvas.width) / 2, chartY);

                    // ç»˜åˆ¶è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ - è¡¨æ ¼å¼å¸ƒå±€
                    const statsY = chartY + latencyChart.canvas.height + 50;
                    tempCtx.fillStyle = '#1f2937';
                    tempCtx.font = 'bold 22px Arial, sans-serif';
                    tempCtx.textAlign = 'center';
                    tempCtx.fillText('è¯¦ç»†ç»Ÿè®¡æ•°æ®', tempCanvas.width / 2, statsY);

                    // ç»˜åˆ¶å·¥å…·åŸç†è¯´æ˜
                    const principleY = statsY + 40;
                    tempCtx.fillStyle = '#1f2937';
                    tempCtx.font = 'bold 18px Arial, sans-serif';
                    tempCtx.textAlign = 'left';
                    tempCtx.fillText('ğŸ”¬ å·¥å…·åŸç†è¯´æ˜', 40, principleY);

                    tempCtx.font = '13px Arial, sans-serif';
                    tempCtx.fillStyle = '#374151';
                    const principleText = [
                        'å»¶è¿Ÿæµ‹è¯•åŸç†: ä½¿ç”¨HTTPè¯·æ±‚å“åº”æ—¶é—´æµ‹é‡ï¼ŒåŒ…å«DNSè§£æã€TCPè¿æ¥ã€HTTPåè®®å¤„ç†ç­‰å®Œæ•´ç½‘ç»œè®¿é—®æ—¶é—´',
                        'ä¸pingåŒºåˆ«: pingæµ‹è¯•ICMPåè®®çš„çº¯ç½‘ç»œå»¶è¿Ÿï¼Œæœ¬å·¥å…·æµ‹è¯•å®é™…ç½‘é¡µè®¿é—®å»¶è¿Ÿï¼Œæ›´è´´è¿‘çœŸå®ä½¿ç”¨ä½“éªŒ',
                        'æ•°æ®ç»Ÿè®¡: æœ€å°/æœ€å¤§/å¹³å‡å»¶è¿ŸåŸºäºæ‰€æœ‰æˆåŠŸè¯·æ±‚è®¡ç®—ï¼Œåœ¨çº¿/ç¦»çº¿ç»Ÿè®¡åŸºäºè¿ç»­çŠ¶æ€å˜åŒ–è®¡ç®—'
                    ];

                    principleText.forEach((line, index) => {
                        tempCtx.fillText(line, 40, principleY + 25 + index * 18);
                    });

                    // ç»˜åˆ¶ç»Ÿè®¡æ•°æ®è¡¨æ ¼
                    const tableY = principleY + 120;
                    const enabledTargetsList = targets.filter(t => t.enabled);

                    if (enabledTargetsList.length > 0) {
                        // è¡¨æ ¼å‚æ•° - å¢å¤§å­—ä½“åè°ƒæ•´å°ºå¯¸
                        const tableWidth = tempCanvas.width - 80;
                        const tableX = 40;
                        const rowHeight = 50; // å¢å¤§è¡Œé«˜ä»¥é€‚åº”æ›´å¤§å­—ä½“
                        const colWidths = [100, 70, 70, 70, 70, 70, 70, 70, 70, 80, 200]; // å¢åŠ ç¦»çº¿æ—¶é•¿å’Œç¦»çº¿è¯¦æƒ…åˆ—

                        // ç»˜åˆ¶è¡¨æ ¼æ ‡é¢˜
                        tempCtx.fillStyle = '#1f2937';
                        tempCtx.font = 'bold 16px Arial, sans-serif';
                        tempCtx.textAlign = 'center';
                        tempCtx.fillText('ç»Ÿè®¡æ•°æ®è¡¨æ ¼', tempCanvas.width / 2, tableY);

                        // ç»˜åˆ¶è¡¨å¤´
                        const headerY = tableY + 30;
                        tempCtx.fillStyle = '#f3f4f6';
                        tempCtx.fillRect(tableX, headerY, tableWidth, rowHeight);
                        tempCtx.strokeStyle = '#d1d5db';
                        tempCtx.lineWidth = 1;
                        tempCtx.strokeRect(tableX, headerY, tableWidth, rowHeight);

                        const headers = ['ç›®æ ‡', 'æœ€å°å»¶è¿Ÿ', 'æœ€å¤§å»¶è¿Ÿ', 'å¹³å‡å»¶è¿Ÿ', 'æ£€æµ‹æ¬¡æ•°', 'æˆåŠŸæ¬¡æ•°', 'æˆåŠŸç‡', 'åœ¨çº¿ç‡', 'ç¦»çº¿æ¬¡æ•°', 'ç¦»çº¿æ—¶é•¿', 'ç¦»çº¿è¯¦æƒ…'];
                        let currentX = tableX;

                        tempCtx.fillStyle = '#374151';
                        tempCtx.font = 'bold 17px Arial, sans-serif'; // å¢å¤§å­—ä½“40%
                        tempCtx.textAlign = 'center';

                        headers.forEach((header, index) => {
                            const colWidth = colWidths[index];
                            tempCtx.fillText(header, currentX + colWidth / 2, headerY + 30); // è°ƒæ•´å‚ç›´ä½ç½®

                            // ç»˜åˆ¶åˆ—åˆ†éš”çº¿
                            if (index < headers.length - 1) {
                                tempCtx.beginPath();
                                tempCtx.moveTo(currentX + colWidth, headerY);
                                tempCtx.lineTo(currentX + colWidth, headerY + rowHeight);
                                tempCtx.stroke();
                            }

                            currentX += colWidth;
                        });

                        // ç»˜åˆ¶æ•°æ®è¡Œ
                        enabledTargetsList.forEach((target, rowIndex) => {
                            const stats = detailedStats[target.name];
                            const now = Date.now();

                            // è®¡ç®—å½“å‰çŠ¶æ€æ—¶é•¿
                            let currentOnlineTime = 0;
                            let currentOfflineTime = 0;

                            if (stats.isCurrentlyOnline && stats.lastOnlineStart) {
                                currentOnlineTime = now - stats.lastOnlineStart;
                            }
                            if (stats.isCurrentlyOffline && stats.lastOfflineStart) {
                                currentOfflineTime = now - stats.lastOfflineStart;
                            }

                            const totalOnlineTime = stats.totalOnlineTime + currentOnlineTime;
                            const totalOfflineTime = stats.totalOfflineTime + currentOfflineTime;
                            const totalSessionTime = now - stats.sessionStart;

                            const rowY = headerY + (rowIndex + 1) * rowHeight;

                            // ç»˜åˆ¶è¡ŒèƒŒæ™¯
                            tempCtx.fillStyle = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
                            tempCtx.fillRect(tableX, rowY, tableWidth, rowHeight);
                            tempCtx.strokeStyle = '#e5e7eb';
                            tempCtx.strokeRect(tableX, rowY, tableWidth, rowHeight);

                            // ç”Ÿæˆç¦»çº¿è¯¦æƒ…æ–‡æœ¬
                            let offlineDetailsText = 'æ— ';
                            if (stats.offlineEvents.length > 0 || stats.isCurrentlyOffline) {
                                let offlineList = [];

                                // æ·»åŠ å½“å‰æ­£åœ¨è¿›è¡Œçš„ç¦»çº¿ï¼ˆå¦‚æœæœ‰ï¼‰
                                if (stats.isCurrentlyOffline && stats.lastOfflineStart) {
                                    const startTime = new Date(stats.lastOfflineStart).toLocaleString('zh-CN', {
                                        month: '2-digit',
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                    const currentDuration = formatDuration(Math.round((now - stats.lastOfflineStart) / 1000));
                                    offlineList.push(`${startTime}-è¿›è¡Œä¸­(${currentDuration})`);
                                }

                                // æ·»åŠ æœ€è¿‘çš„å†å²ç¦»çº¿è®°å½•
                                if (stats.offlineEvents.length > 0) {
                                    const recentOffline = stats.offlineEvents[stats.offlineEvents.length - 1];
                                    const startTime = new Date(recentOffline.start).toLocaleString('zh-CN', {
                                        month: '2-digit',
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                    const endTime = new Date(recentOffline.end).toLocaleString('zh-CN', {
                                        month: '2-digit',
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                    const duration = formatDuration(Math.round(recentOffline.duration / 1000));
                                    offlineList.push(`${startTime}-${endTime}(${duration})`);
                                }

                                offlineDetailsText = offlineList.join('; ');
                                if (stats.offlineEvents.length > 1) {
                                    offlineDetailsText += `; ç­‰${stats.offlineEvents.length}æ¬¡`;
                                }
                            }

                            // å‡†å¤‡æ•°æ®
                            const rowData = [
                                target.name,
                                stats.minLatency !== null ? stats.minLatency + 'ms' : 'â€”',
                                stats.maxLatency !== null ? stats.maxLatency + 'ms' : 'â€”',
                                stats.avgLatency !== null ? Math.round(stats.avgLatency) + 'ms' : 'â€”',
                                stats.totalChecks.toString(),
                                stats.successfulChecks.toString(),
                                stats.totalChecks > 0 ? (stats.successfulChecks / stats.totalChecks * 100).toFixed(1) + '%' : '0%',
                                totalSessionTime > 0 ? (totalOnlineTime / totalSessionTime * 100).toFixed(1) + '%' : '0%',
                                stats.offlineCount.toString(),
                                formatDuration(Math.round(totalOfflineTime / 1000)), // ç¦»çº¿æ—¶é•¿
                                offlineDetailsText // ç¦»çº¿è¯¦æƒ…
                            ];

                            // ç»˜åˆ¶æ•°æ®
                            currentX = tableX;
                            tempCtx.fillStyle = '#374151';
                            tempCtx.font = '15px Arial, sans-serif'; // å¢å¤§å­—ä½“40%
                            tempCtx.textAlign = 'center';

                            rowData.forEach((data, colIndex) => {
                                const colWidth = colWidths[colIndex];

                                // ç¬¬ä¸€åˆ—ï¼ˆç›®æ ‡åç§°ï¼‰ç‰¹æ®Šå¤„ç†
                                if (colIndex === 0) {
                                    // ç»˜åˆ¶é¢œè‰²æŒ‡ç¤ºå™¨
                                    tempCtx.fillStyle = target.color;
                                    tempCtx.fillRect(currentX + 10, rowY + 12, 12, 12);

                                    // ç»˜åˆ¶ç›®æ ‡åç§°
                                    tempCtx.fillStyle = '#374151';
                                    tempCtx.textAlign = 'left';
                                    tempCtx.fillText(data, currentX + 30, rowY + 30); // è°ƒæ•´å‚ç›´ä½ç½®
                                    tempCtx.textAlign = 'center';
                                } else if (colIndex === rowData.length - 1) {
                                    // ç¦»çº¿è¯¦æƒ…åˆ— - ä½¿ç”¨æ›´å°å­—ä½“å’Œå·¦å¯¹é½
                                    tempCtx.font = '11px Arial, sans-serif';
                                    tempCtx.textAlign = 'left';
                                    // å¤„ç†é•¿æ–‡æœ¬æ¢è¡Œ
                                    const maxWidth = colWidth - 10;
                                    const words = data.split(' ');
                                    let line = '';
                                    let y = rowY + 20;

                                    for (let n = 0; n < words.length; n++) {
                                        const testLine = line + words[n] + ' ';
                                        const metrics = tempCtx.measureText(testLine);
                                        const testWidth = metrics.width;
                                        if (testWidth > maxWidth && n > 0) {
                                            tempCtx.fillText(line, currentX + 5, y);
                                            line = words[n] + ' ';
                                            y += 15;
                                        } else {
                                            line = testLine;
                                        }
                                    }
                                    tempCtx.fillText(line, currentX + 5, y);

                                    // æ¢å¤å­—ä½“å’Œå¯¹é½æ–¹å¼
                                    tempCtx.font = '15px Arial, sans-serif';
                                    tempCtx.textAlign = 'center';
                                } else {
                                    tempCtx.fillText(data, currentX + colWidth / 2, rowY + 30); // è°ƒæ•´å‚ç›´ä½ç½®
                                }

                                // ç»˜åˆ¶åˆ—åˆ†éš”çº¿
                                if (colIndex < rowData.length - 1) {
                                    tempCtx.strokeStyle = '#e5e7eb';
                                    tempCtx.beginPath();
                                    tempCtx.moveTo(currentX + colWidth, rowY);
                                    tempCtx.lineTo(currentX + colWidth, rowY + rowHeight);
                                    tempCtx.stroke();
                                }

                                currentX += colWidth;
                            });
                        });
                    }

                    // è½¬æ¢ä¸ºPNGå¹¶ä¸‹è½½
                    const url = tempCanvas.toDataURL('image/png', 1.0);
                    const link = document.createElement('a');
                    const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                    link.download = `ç½‘ç»œå»¶è¿Ÿç›‘æµ‹è¯¦ç»†æŠ¥å‘Š-${timestamp}.png`;
                    link.href = url;
                    link.click();

                    showNotification('è¯¦ç»†æŠ¥å‘Šå¯¼å‡ºæˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    showNotification('å›¾è¡¨å¯¼å‡ºå¤±è´¥', 'error');
                }

                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            }, 500);
        });

        // è‡ªå®šä¹‰ç½‘å€åŠŸèƒ½
        addCustomBtn.addEventListener("click", showCustomUrlModal);
        document.getElementById('closeCustomModal').addEventListener('click', hideCustomUrlModal);
        document.getElementById('cancelCustomUrl').addEventListener('click', hideCustomUrlModal);
        document.getElementById('confirmCustomUrl').addEventListener('click', handleAddCustomUrl);

        // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
        document.getElementById('customUrlModal').addEventListener('click', function (e) {
            if (e.target === this) {
                hideCustomUrlModal();
            }
        });

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                hideCustomUrlModal();
            }
        });

        // æ¸…é™¤æ•°æ®åŠŸèƒ½
        clearBtn.addEventListener("click", () => {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                latencyChart.data.labels = [];
                latencyChart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                latencyChart.update("none");

                // é‡ç½®è¯¦ç»†ç»Ÿè®¡
                Object.keys(detailedStats).forEach(targetName => {
                    detailedStats[targetName] = {
                        latencies: [],
                        minLatency: null,
                        maxLatency: null,
                        avgLatency: null,
                        offlineCount: 0,
                        totalOfflineTime: 0,
                        lastOfflineStart: null,
                        isCurrentlyOffline: false,
                        offlineEvents: [],
                        totalOnlineTime: 0,
                        lastOnlineStart: null,
                        isCurrentlyOnline: false,
                        onlineEvents: [],
                        sessionStart: Date.now(),
                        totalChecks: 0,
                        successfulChecks: 0
                    };
                });

                // é‡ç½®è¡¨æ ¼çŠ¶æ€
                targets.forEach(t => {
                    const statusElement = document.getElementById(`${t.name}-status`);
                    const latencyElement = document.getElementById(`${t.name}-latency`);
                    const timeElement = document.getElementById(`${t.name}-time`);
                    const latencyStatsElement = document.getElementById(`${t.name}-latency-stats`);
                    const onlineStatsElement = document.getElementById(`${t.name}-online-stats`);
                    const offlineStatsElement = document.getElementById(`${t.name}-offline-stats`);

                    const statusContainer = statusElement.parentElement;
                    statusContainer.innerHTML = `
                        <span class="status-indicator status-checking"></span>
                        <span id="${t.name}-status" class="ml-2 text-sm w-12 text-center text-gray-600">å¾…æ£€æµ‹</span>
                    `;
                    latencyElement.textContent = "â€”";
                    latencyElement.className = "px-4 py-4 whitespace-nowrap text-center text-sm font-mono text-gray-500";
                    timeElement.textContent = "â€”";

                    if (latencyStatsElement) {
                        latencyStatsElement.innerHTML = `æœ€å°: â€”<br>æœ€å¤§: â€”<br>å¹³å‡: â€”`;
                    }
                    if (onlineStatsElement) {
                        onlineStatsElement.innerHTML = `åœ¨çº¿æ—¶é•¿: â€”<br>åœ¨çº¿ç‡: â€”`;
                    }
                    if (offlineStatsElement) {
                        offlineStatsElement.innerHTML = `ç¦»çº¿æ¬¡æ•°: 0<br>ç¦»çº¿æ—¶é•¿: 0s`;
                    }
                });

                // é‡ç½®è¯¦ç»†ç»Ÿè®¡å¡ç‰‡
                initializeDetailedStats();

                showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'info');
            }
        });

        // é€šçŸ¥åŠŸèƒ½
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-md shadow-lg transform translate-x-full transition-transform duration-300`;

            const colors = {
                'success': 'bg-green-500 text-white',
                'error': 'bg-red-500 text-white',
                'info': 'bg-blue-500 text-white',
                'warning': 'bg-yellow-500 text-black'
            };

            notification.className += ' ' + colors[type];
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => notification.classList.remove('translate-x-full'), 10);

            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // =============== å»¶è¿Ÿä¼˜åŒ– ===============
        function optimizeLatency(rawLatency, targetName) {
            if (rawLatency === null) return null;

            let optimized = Math.max(1, Math.min(rawLatency, 10000));

            if (rawLatency !== optimized) {
                console.log(`${targetName} å»¶è¿Ÿä¼˜åŒ–: ${rawLatency}ms -> ${optimized}ms`);
            }

            return optimized;
        }

        // =============== åˆå§‹åŒ– ===============
        document.addEventListener('DOMContentLoaded', function () {
            initializeTargetSelector();
            initializeTable();
            initializeDetailedStats();
            initializeChart();

            // ç«‹å³å¼€å§‹æ£€æµ‹ï¼ˆé»˜è®¤1ç§’é—´éš”ï¼‰
            runCheck();
            startLoop();

            console.log('å®æ—¶HTTPå»¶è¿Ÿç›‘æµ‹å·¥å…·å·²å¯åŠ¨');
            showNotification('ç›‘æµ‹å·¥å…·å·²å¯åŠ¨ï¼Œæ­£åœ¨æ£€æµ‹ç½‘ç«™å»¶è¿Ÿ...', 'info');
        });
    </script>
</body>

</html>
